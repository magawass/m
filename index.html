<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Magawa Secondary School</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; }
header { background:#004466; color:white; padding:15px; text-align:center; }
nav { background:#007799; padding:10px; display:flex; justify-content:center; flex-wrap:wrap; }
nav button { background:white; border:none; margin:5px; padding:10px 20px; cursor:pointer; font-weight:bold; color:#004466; border-radius:6px; transition:0.3s; }
nav button:hover { background:#cce7ff; }
section { display:none; padding:20px; background:white; max-width:900px; margin:20px auto; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
section.active { display:block; }
input, textarea { width:100%; max-width:400px; padding:8px; margin:6px 0; }
.btn { background:#004466; color:white; border:none; padding:10px 20px; margin-top:10px; border-radius:5px; cursor:pointer;}
.btn:hover { background:#007799; }
#student-area, #admin-area { display:none; }
footer { background:#f4f4f9; text-align:center; padding:10px 0; color:#777; margin-top:40px; }
</style>
</head>
<body>

<header>
  <h1>Magawa Secondary School</h1>
  <p>Official Student Portal</p>
</header>

<nav>
  <button onclick="showSection('home')">Home</button>
  <button onclick="showSection('about')">About</button>
  <button onclick="showSection('admissions')">Admissions</button>
  <button onclick="showSection('student')">Student Portal</button>
  <button onclick="showSection('admin')">Admin</button>
</nav>

<!-- HOME -->
<section id="home" class="active">
  <h2>Welcome to Magawa Secondary School</h2>
  <p>This is the official online portal. Students can view their results here.</p>
</section>

<!-- ABOUT -->
<section id="about">
  <h2>About Us</h2>
  <p id="about-text">Loading content...</p>
  <div id="about-images"></div>
</section>

<!-- ADMISSIONS -->
<section id="admissions">
  <h2>Admissions</h2>
  <p id="admissions-text">Loading content...</p>
</section>

<!-- STUDENT PORTAL -->
<section id="student">
  <h2>Student Portal</h2>
  <div id="student-login">
    <label for="examNumber">Enter Exam Number:</label>
    <input type="text" id="examNumber" placeholder="e.g. 1001">
    <button class="btn" onclick="studentLogin()">Login</button>
  </div>
  <div id="student-area">
    <h3 id="student-welcome"></h3>
    <a id="result-link" href="#" target="_blank" class="btn">View/Download Result</a><br><br>
    <button class="btn" onclick="studentLogout()">Logout</button>
  </div>
</section>

<!-- ADMIN PORTAL -->
<section id="admin">
  <h2>Admin Portal</h2>
  <div id="admin-login">
    <label for="adminPass">Admin Password:</label>
    <input type="password" id="adminPass">
    <button class="btn" onclick="adminLogin()">Login</button>
  </div>

  <div id="admin-area">
    <h3>GitHub Token (manual entry)</h3>
    <input type="password" id="githubToken" placeholder="Enter GitHub Personal Access Token">

    <h3>Edit About/Admissions</h3>
    <textarea id="edit-about" rows="4" placeholder="About text"></textarea>
    <textarea id="edit-admissions" rows="4" placeholder="Admissions text"></textarea>
    <button class="btn" onclick="saveContentToGitHub()">Save Content to GitHub</button>

    <h3>Upload PDF Results (multiple)</h3>
    <input type="file" id="pdfFiles" accept="application/pdf" multiple>
    <textarea id="pdfExamNumbers" rows="2" placeholder="Enter Exam Numbers (comma or newline separated)"></textarea>
    <button class="btn" onclick="uploadPDFsToGitHub()">Upload PDFs</button>

    <h3>Upload Logo</h3>
    <input type="file" id="logoFile" accept="image/*">
    <button class="btn" onclick="uploadLogoToGitHub()">Upload Logo</button>

    <h3>About Us Images</h3>
    <input type="file" id="aboutImages" accept="image/*" multiple>
    <button class="btn" onclick="uploadAboutImagesToGitHub()">Upload About Images</button>
    <small>Upload one or more images for the About Us section.</small>

    <br><br>
    <button class="btn" onclick="adminLogout()">Logout</button>
  </div>
</section>

<footer>
  <p>&copy; 2025 Magawa Secondary School</p>
</footer>

<script>
// --- ADMIN PASSWORD ---
const adminPassword = 'M@gawa#2025!Admin';

// --- Navigation ---
function showSection(id) {
  document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// --- Admin Login ---
function adminLogin() {
  const pass = document.getElementById('adminPass').value.trim();
  if(pass === adminPassword){
    document.getElementById('admin-login').style.display='none';
    document.getElementById('admin-area').style.display='block';
  } else alert('Wrong password');
}
function adminLogout(){
  document.getElementById('admin-area').style.display='none';
  document.getElementById('admin-login').style.display='block';
  document.getElementById('githubToken').value = '';
}

// --- Student Login ---
function studentLogin() {
  let examNumber = document.getElementById('examNumber').value.trim();
  if(!examNumber) return alert('Enter Exam Number');
  examNumber = parseInt(examNumber,10).toString().padStart(4,'0');
  const fileUrl = `results/${examNumber}.pdf`;
  fetch(fileUrl,{method:'HEAD'}).then(res=>{
    if(res.ok){
      document.getElementById('student-login').style.display='none';
      document.getElementById('student-area').style.display='block';
      document.getElementById('student-welcome').innerText = `Welcome Candidate No: ${examNumber}`;
      document.getElementById('result-link').href = fileUrl;
    } else alert('Result not found.');
  }).catch(()=>alert('Error checking result.'));
}
function studentLogout(){
  document.getElementById('examNumber').value='';
  document.getElementById('student-login').style.display='block';
  document.getElementById('student-area').style.display='none';
}

// --- Unicode base64 encode/decode (safe for all text) ---
function toBase64(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
    return String.fromCharCode('0x'+p1);
  }));
}
function fromBase64(str) {
  return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

// --- GitHub API helper ---
async function githubPut(path, contentBase64){
  try {
    const token = document.getElementById('githubToken').value.trim();
    if(!token) return alert('Enter GitHub token');
    const repo = 'magawass/m';
    const branch = 'main';
    let sha = null;
    const resp = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
      headers:{'Authorization':'token '+token}
    });
    if(resp.status===200){
      const data = await resp.json();
      sha = data.sha;
    }
    const putResp = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
      method:'PUT',
      headers:{
        'Authorization':'token '+token,
        'Content-Type':'application/json'
      },
      body:JSON.stringify({
        message:`Update ${path}`,
        content:contentBase64,
        branch,
        ...(sha ? {sha} : {})
      })
    });
    if(putResp.ok) alert(`${path} uploaded successfully`);
    else {
      const err = await putResp.json();
      alert(`Failed to upload ${path}: ${err.message || putResp.status}`);
    }
  } catch (err) {
    alert(`Unexpected error uploading ${path}`);
  }
}

// --- Upload multiple PDFs ---
function uploadPDFsToGitHub(){
  const files = document.getElementById('pdfFiles').files;
  let examNumbers = document.getElementById('pdfExamNumbers').value.trim();
  if(!files.length || !examNumbers) return alert('Select files and enter exam numbers');
  examNumbers = examNumbers.split(/[\n,]+/)
    .map(e=>parseInt(e.trim(),10))
    .filter(e=>!isNaN(e))
    .map(e=>e.toString().padStart(4,'0'));
  if(examNumbers.length !== files.length) {
    alert('Number of files must match number of exam numbers.');
    return;
  }
  Array.from(files).forEach((file, idx)=>{
    const exam = examNumbers[idx];
    const reader = new FileReader();
    reader.onload = e=>{
      const content = e.target.result.split(',')[1];
      githubPut(`results/${exam}.pdf`,content);
    }
    reader.readAsDataURL(file);
  });
}

// --- Upload Logo ---
function uploadLogoToGitHub(){
  const file = document.getElementById('logoFile').files[0];
  if(!file) return alert('Select logo file');
  const reader = new FileReader();
  reader.onload = e=>{
    const content = e.target.result.split(',')[1];
    githubPut(`images/logo.png`,content);
  }
  reader.readAsDataURL(file);
}

// --- Upload About Images ---
function uploadAboutImagesToGitHub() {
  const files = document.getElementById('aboutImages').files;
  if(!files.length) return alert('Select images to upload');
  Array.from(files).forEach((file, idx)=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const content = e.target.result.split(',')[1];
      // Save as images/about-<timestamp>-<idx>.<ext>
      let ext = file.name.split('.').pop();
      githubPut(`images/about-${Date.now()}-${idx}.${ext}`, content);
    }
    reader.readAsDataURL(file);
  });
}

// --- Save About/Admissions ---
function saveContentToGitHub(){
  const about = document.getElementById('edit-about').value.trim();
  const admissions = document.getElementById('edit-admissions').value.trim();
  if(about) githubPut('about.txt', toBase64(about));
  if(admissions) githubPut('admissions.txt', toBase64(admissions));
}

// --- Load About/Admissions and About Images from GitHub ---
async function loadGitHubContent(){
  const repo = 'magawass/m';
  const branch = 'main';
  const baseURL = `https://api.github.com/repos/${repo}/contents`;

  async function fetchText(file){
    try {
      const resp = await fetch(`${baseURL}/${file}?ref=${branch}`);
      if(resp.ok){
        const data = await resp.json();
        return fromBase64(data.content);
      } else return null;
    } catch { return null; }
  }

  // Load about/admissions text
  const about = await fetchText('about.txt');
  const admissions = await fetchText('admissions.txt');
  if(about) document.getElementById('about-text').innerText = about;
  if(admissions) document.getElementById('admissions-text').innerText = admissions;

  // Load images for About Us section
  try {
    const resp = await fetch(`${baseURL}/images?ref=${branch}`);
    if(resp.ok){
      const data = await resp.json();
      // Filter for files matching about-*.jpg/png/jpeg/gif
      const aboutImgs = data.filter(f=>/^about-.*\.(jpg|jpeg|png|gif)$/i.test(f.name));
      const container = document.getElementById('about-images');
      container.innerHTML = '';
      aboutImgs.forEach(img=>{
        const imgTag = document.createElement('img');
        imgTag.src = img.download_url;
        imgTag.style.maxWidth = '200px';
        imgTag.style.margin = '8px';
        container.appendChild(imgTag);
      });
    }
  } catch(e) {}
}

// Run content loader on page ready
document.addEventListener('DOMContentLoaded', loadGitHubContent);
</script>

</body>
</html>
