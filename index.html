<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Magawa Secondary School</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; }
    header { background:#004466; color:white; padding:15px; text-align:center; }
    nav { background:#007799; padding:10px; display:flex; justify-content:center; flex-wrap:wrap; }
    nav button { background:white; border:none; margin:5px; padding:10px 20px; cursor:pointer; font-weight:bold; color:#004466; border-radius:6px; transition:0.3s; }
    nav button:hover { background:#cce7ff; }
    section { display:none; padding:20px; background:white; max-width:900px; margin:20px auto; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
    section.active { display:block; }
    input, textarea, select { width:100%; max-width:400px; padding:8px; margin:6px 0; }
    .btn { background:#004466; color:white; border:none; padding:10px 20px; margin-top:10px; border-radius:5px; cursor:pointer;}
    .btn:hover { background:#007799; }
    #student-area, #admin-area { display:none; }
    footer { background:#f4f4f9; text-align:center; padding:10px 0; color:#777; margin-top:40px; }
    .file-entry { display:flex; justify-content:space-between; align-items:center; margin:5px 0; padding:5px; background:#eef; border-radius:5px; }
    .file-entry button { margin-left:10px; background:#c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; }
    .file-entry button:hover { background:#900; }
  </style>
</head>
<body>

<header>
  <img id="school-logo" src="" alt="School Logo" style="height:60px; margin-bottom:10px; display:none;">
  <h1>Magawa Secondary School</h1>
  <p>Official Student Portal</p>
</header>

<nav>
  <button onclick="showSection('home')">Home</button>
  <button onclick="showSection('public')">Announcements</button>
  <button onclick="showSection('student')">Results Portal</button>
  <button onclick="showSection('admin')">Admin</button>
</nav>

<section id="home" class="active">
  <h2>Welcome to Magawa Secondary School</h2>
  <p id="home-text">Loading content...</p>
</section>

<section id="public">
  <h2>Announcements</h2>
  <p id="public-text">Loading content...</p>
</section>

<section id="student">
  <h2>Results Portal</h2>
  <div id="student-login">
    <div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px;">
      <div>
        <label for="student-class">Select Class:</label><br>
        <select id="student-class">
          <option value="form1">Form 1</option>
          <option value="form2">Form 2</option>
          <option value="form3">Form 3</option>
          <option value="form4">Form 4</option>
        </select>
      </div>
      <div>
        <label for="examNumber">Enter Exam Number:</label><br>
        <input type="text" id="examNumber" placeholder="e.g. 1001">
      </div>
      <button class="btn" onclick="studentLogin()">Login</button>
    </div>
  </div>
  <div id="student-area">
    <h3 id="student-welcome"></h3>
    <button class="btn" onclick="viewStudentPDF()">View/Download Result</button>
    <button class="btn" onclick="studentLogout()">Logout</button>
  </div>
</section>

<section id="admin">
  <h2>Admin Portal</h2>
  <div id="admin-login">
    <label for="adminPass">Admin Password:</label>
    <input type="password" id="adminPass">
    <button class="btn" onclick="adminLogin()">Login</button>
  </div>

  <div id="admin-area">
    <h3>GitHub Token</h3>
    <input type="password" id="githubToken" placeholder="Enter GitHub Personal Access Token">

    <h3>Edit Home</h3>
    <textarea id="edit-home" rows="4" placeholder="Home text"></textarea>
    <button class="btn" onclick="saveHomeText()">Save Home</button>

    <h3>Edit Announcements</h3>
    <textarea id="edit-public" rows="4" placeholder="Announcements text"></textarea>
    <button class="btn" onclick="saveContentToGitHub()">Save Announcements</button>

    <h3>Upload Multiple PDF Results</h3>
    <input type="file" id="pdfFiles" accept=".pdf" multiple>
    <select id="pdfClass">
      <option value="form1">Form 1</option>
      <option value="form2">Form 2</option>
      <option value="form3">Form 3</option>
      <option value="form4">Form 4</option>
    </select>
    <button class="btn" onclick="uploadMultiplePDFs()">Upload PDFs</button>

    <h3>Manage Uploaded PDFs</h3>
    <select id="listClass" onchange="loadPDFList()">
      <option value="form1">Form 1</option>
      <option value="form2">Form 2</option>
      <option value="form3">Form 3</option>
      <option value="form4">Form 4</option>
    </select>
    <div id="pdf-list" style="margin-top:10px;"></div>

    <br><br>
    <button class="btn" onclick="adminLogout()">Logout</button>
  </div>
</section>

<footer>
  <p>&copy; 2025 Magawa Secondary School. Designed by Chiku Lubaini</p>
</footer>
<script>
const adminPassword = 'M@gawa#2025!Admin';
let studentPDFUrl = '';

function showSection(id) {
  document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function adminLogin() {
  const pass = document.getElementById('adminPass').value.trim();
  if (pass === adminPassword) {
    document.getElementById('admin-login').style.display = 'none';
    document.getElementById('admin-area').style.display = 'block';
    loadPDFList();
  } else alert('Wrong password');
}

function adminLogout() {
  document.getElementById('admin-area').style.display = 'none';
  document.getElementById('admin-login').style.display = 'block';
  document.getElementById('githubToken').value = '';
}

function studentLogout() {
  document.getElementById('examNumber').value = '';
  document.getElementById('student-login').style.display = 'block';
  document.getElementById('student-area').style.display = 'none';
  studentPDFUrl = '';
}

async function studentLogin() {
  let examNumber = document.getElementById('examNumber').value.trim();
  let studentClass = document.getElementById('student-class').value;
  if (!examNumber) return alert('Enter Exam Number');
  examNumber = parseInt(examNumber, 10).toString().padStart(4, '0');

  const fileUrl = `https://magawass.github.io/m/results/${studentClass}/${examNumber}.pdf`;

  try {
    const res = await fetch(fileUrl, { method: 'HEAD' });
    if (res.ok) {
      studentPDFUrl = fileUrl;
      document.getElementById('student-login').style.display = 'none';
      document.getElementById('student-area').style.display = 'block';
      document.getElementById('student-welcome').innerText = `Welcome Candidate No: ${examNumber} (${studentClass.replace('form', 'Form ')})`;
    } else {
      alert('Result PDF not found.');
    }
  } catch {
    alert('Error checking result.');
  }
}

function viewStudentPDF() {
  if (studentPDFUrl) window.open(studentPDFUrl, '_blank');
}

function uploadMultiplePDFs() {
  const files = document.getElementById('pdfFiles').files;
  const formClass = document.getElementById('pdfClass').value;
  const token = document.getElementById('githubToken').value.trim();
  if (!files.length || !token) return;

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = async e => {
      const content = e.target.result.split(',')[1];
      const path = `results/${formClass}/${file.name}`;
      let sha = null;

      try {
        const check = await fetch(`https://api.github.com/repos/magawass/m/contents/${path}`, {
          headers: { 'Authorization': 'token ' + token }
        });
        if (check.ok) {
          const data = await check.json();
          sha = data.sha;
        }
      } catch {}

      await fetch(`https://api.github.com/repos/magawass/m/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': 'token ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Upload ${file.name}`,
          content,
          branch: 'main',
          ...(sha ? { sha } : {})
        })
      });
      loadPDFList();
    };
    reader.readAsDataURL(file);
  });
}

function loadPDFList() {
  const formClass = document.getElementById('listClass').value;
  const listContainer = document.getElementById('pdf-list');
  listContainer.innerHTML = 'Loading...';

  fetch(`https://api.github.com/repos/magawass/m/contents/results/${formClass}`)
    .then(res => res.ok ? res.json() : [])
    .then(data => {
      listContainer.innerHTML = '';
      if (Array.isArray(data)) {
        data.forEach(file => {
          if (file.name.endsWith('.pdf')) {
            const entry = document.createElement('div');
            entry.className = 'file-entry';
            entry.innerHTML = `
              <a href="${file.download_url}" target="_blank">${file.name}</a>
              <button onclick="deletePDF('${formClass}', '${file.name}')">Delete</button>
            `;
            listContainer.appendChild(entry);
          }
        });
      } else {
        listContainer.innerHTML = 'No files found.';
      }
    })
    .catch(() => {
      listContainer.innerHTML = 'Error loading files.';
    });
}

function deletePDF(formClass, filename) {
  const token = document.getElementById('githubToken').value.trim();
  if (!token) return;
  const path = `results/${formClass}/${filename}`;
  const repo = 'magawass/m';
  const branch = 'main';

  fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
    headers: { 'Authorization': 'token ' + token }
  })
  .then(resp => resp.ok ? resp.json() : Promise.reject('File not found'))
  .then(data => {
    const sha = data.sha;
    return fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'token ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Delete ${path}`,
        sha,
        branch
      })
    });
  })
  .then(() => loadPDFList())
  .catch(err => alert(err));
}

function toBase64(str) {
  return btoa(unescape(encodeURIComponent(str)));
}

function fromBase64(str) {
  return decodeURIComponent(escape(atob(str)));
}

async function githubPut(path, contentBase64) {
  const token = document.getElementById('githubToken').value.trim();
  if (!token) return;
  const repo = 'magawass/m';
  const branch = 'main';
  let sha = null;

  try {
    const resp = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      headers: { 'Authorization': 'token ' + token }
    });
    if (resp.ok) {
      const data = await resp.json();
      sha = data.sha;
    }
  } catch {}

  await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
    method: 'PUT',
    headers: {
      'Authorization': 'token ' + token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: `Update ${path}`,
      content: contentBase64,
      branch,
      ...(sha ? { sha } : {})
    })
  });
}

function saveHomeText() {
  const home = document.getElementById('edit-home').value.trim();
  if (home) {
    githubPut('home.txt', toBase64(home));
    document.getElementById('home-text').innerText = home;
  }
}

function saveContentToGitHub() {
  const publicText = document.getElementById('edit-public').value.trim();
  if (publicText) {
    githubPut('public.txt', toBase64(publicText));
    document.getElementById('public-text').innerText = publicText;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const repo = 'magawass/m';
  const branch = 'main';
  const baseURL = `https://api.github.com/repos/${repo}/contents`;

  async function fetchText(file) {
    try {
      const resp = await fetch(`${baseURL}/${file}?ref=${branch}`);
      if (resp.ok) {
        const data = await resp.json();
        return fromBase64(data.content);
      } else return null;
    } catch { return null; }
  }

  fetchText('home.txt').then(home => {
    if (home) {
      document.getElementById('home-text').innerText = home;
      document.getElementById('edit-home').value = home;
    }
  });

  fetchText('public.txt').then(publicText => {
    if (publicText) {
      document.getElementById('public-text').innerText = publicText;
      document.getElementById('edit-public').value = publicText;
    }
  });

  fetch('https://raw.githubusercontent.com/magawass/m/main/images/logo.png')
    .then(res => {
      if (res.ok) {
        document.getElementById('school-logo').src = res.url;
        document.getElementById('school-logo').style.display = 'inline-block';
      }
    });
});
</script>
</body>
</html>
